/*! network-generation 2015-01-01 */
"use strict";function formatNumber(a,b){for(var a=a.toFixed(b)+"",c=a.split("."),d=c[0],e=c.length>1?"."+c[1]:"",f=/(\d+)(\d{3})/;f.test(d);)d=d.replace(f,"$1,$2");return parseFloat(d+e)}var fs=require("fs"),path=require("path"),geoCalc=require("geo-calculator"),PNGReader=require("png.js"),siteId=0,losLinkId=0,networkElementId=0,time=new Date;console.log(time);var config={numberOfAggregatorSites:1e3,maxNumberOfNetworkElementsPerSite:6,selectedMap:"germany",maps:{germany:{boundingbox:[47.2701114,55.099161,5.8663153,15.0419319],imageUrl:"images/Germany.png"}},outputFilename:"target/network.json"},map=config.maps[config.selectedMap],latMax=map.boundingbox[1],lngMax=map.boundingbox[3],latMin=map.boundingbox[0],lngMin=map.boundingbox[2],network={aggSiteIds:[],sites:[],losLinks:[],networkElements:[]},createNetworkElements=function(a){for(var b=[],c=0,d=Math.random()*config.maxNumberOfNetworkElementsPerSite;d>c;){var e={id:networkElementId++,userId:a.id+"-"+d,name:"sysName-"+a.id+"-"+c,type:"unknown"};network.networkElements.push(e),b.push(e.id),c++}return b},longitude=function(){var a=map.boundingbox[2],b=map.boundingbox[3],c=a+(b-a)*Math.random();return formatNumber(c,6)},latitude=function(){var a=map.boundingbox[0],b=map.boundingbox[1],c=a+(b-a)*Math.random();return formatNumber(c,6)},calculateGeo=function(a){var b=(1e3*(2+18*Math.random())).toFixed(3),c=(360*Math.random()).toFixed(2),d={point1:a.geo,distance:b,azimuth:c},e=geoCalc.point2(d,function(a,b){return a&&console.error(a),b});return e},createSite=function(a,b,c){var d=c.getWidth()-1,e=c.getHeight()-1,f=network.sites.length,g=null===a?"Aggregator":"BaseStation",h=null===a?[longitude(),latitude()]:calculateGeo(a),i=Math.round((h[0]-lngMin)/(lngMax-lngMin)*d),j=e-Math.round((h[1]-latMin)/(latMax-latMin)*e),k=[127,127,127,127];for(i>=0&&d>=i&j>=0&&e>=j&&(k=c.getPixel(i,j));255===k[0]&&255===k[1]&&255===k[2];)h=null===a?[longitude(),latitude()]:calculateGeo(a),i=Math.round((h[0]-lngMin)/(lngMax-lngMin)*d),j=e-Math.round((h[1]-latMin)/(latMax-latMin)*e),k=[127,127,127,127],i>=0&&d>=i&j>=0&&e>=j&&(k=c.getPixel(i,j));var l={id:f,userId:g+"-"+pad(f,5),type:g,geo:h,losLinks:[]};return network.sites.push(l),l.networkElements=createNetworkElements(l,network),addLosLinks(b,l,c),l},addLosLinks=function(a,b,c){for(var d=0;a>d;d++){var e=createSite(b,a-2,c),f={id:losLinkId++,userId:b.userId+">>"+e.userId,from:b.id,to:e.id};network.losLinks.push(f),b.losLinks.push(f.id);var g={id:losLinkId++,userId:e.userId+">>"+b.userId,from:e.id,to:b.id};network.losLinks.push(g),e.losLinks.push(g.id)}},pad=function(a,b){for(var c=a+"";c.length<b;)c="0"+c;return c},writefile=function(a){var b=JSON.stringify(a,null," ");fs.writeFile(config.outputFilename,b,function(b){if(b)console.log(b);else{var c={message:"The file '"+config.outputFilename+"' was saved!",aggs:a.aggSiteIds.length,sites:a.sites.length,losLinks:a.losLinks.length,networkElements:a.networkElements.length};console.log(c)}})},save=function(a){var b=path.dirname(config.outputFilename);fs.exists(b,function(c){c?writefile(a):fs.mkdir(b,function(b){if(b)throw b;writefile(a)})})},fillNetwork=function(a,b,c){for(var d=0;a>d;){var e=createSite(null,5,b);network.aggSiteIds.push(e.id),network.sites.push(e),d++}return c(network)},getImage=function(a){fs.readFile(config.maps[config.selectedMap].imageUrl,function(b,c){var d=new PNGReader(c);d.parse(function(b,c){if(b)throw b;return a(c)})})};getImage(function(a){console.log("time: "+(new Date-time)),fillNetwork(config.numberOfAggregatorSites,a,function(a){console.log("time: "+(new Date-time)),save(a),console.log("time: "+(new Date-time))})});